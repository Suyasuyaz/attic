name: Close Parent Issue When All Tasks Done

on:
  issues:
    types: [closed]  # å­IssueãŒ Closed ã«ãªã£ãŸã¨ãã«å®Ÿè¡Œ

jobs:
  close-parent:
    runs-on: ubuntu-latest
    steps:
      - name: Check if parent issue should be closed
        uses: actions/github-script@v6
        with:
          script: |
            const issue_number = context.payload.issue.number;
            const repo = context.repo;
            const octokit = github.rest;
            
            console.log(`ğŸ” Checking for parent issue related to child issue #${issue_number}`);

            // å­Issueã®æƒ…å ±ã‚’å–å¾—
            const childIssue = await octokit.issues.get({
              ...repo,
              issue_number: issue_number
            });

            const parentIssueNumber = childIssue.data.body
              ? (childIssue.data.body.match(/Parent Issue: #(\d+)/) || [])[1]
              : null;

            if (!parentIssueNumber) {
              console.log("âš ï¸ No parent issue found. Exiting.");
              return;
            }

            console.log(`ğŸ”— Found parent issue: #${parentIssueNumber}`);

            // è¦ªIssueã®æƒ…å ±ã‚’å–å¾—
            const parentIssue = await octokit.issues.get({
              ...repo,
              issue_number: parseInt(parentIssueNumber, 10)
            });

            if (!parentIssue.data.body) {
              console.log("âš ï¸ Parent issue has no body. Exiting.");
              return;
            }

            console.log("âœ… Parent issue body found, checking child tasks...");

            // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆï¼ˆå­Issueã®ãƒªã‚¹ãƒˆï¼‰ã‚’å–å¾—
            const matches = parentIssue.data.body.match(/- \[ \] #(\d+)/g) || [];

            if (matches.length === 0) {
              console.log("âš ï¸ No child tasks found in parent issue. Exiting.");
              return;
            }

            console.log(`ğŸ“ Found ${matches.length} child tasks in parent issue.`);

            // ã™ã¹ã¦ã®å­IssueãŒClosedã‹ãƒã‚§ãƒƒã‚¯
            let allClosed = true;
            for (const match of matches) {
              const childNumber = parseInt(match.match(/#(\d+)/)[1], 10);
              const child = await octokit.issues.get({ ...repo, issue_number: childNumber });
              if (child.data.state !== "closed") {
                allClosed = false;
                console.log(`ğŸš¨ Child Issue #${childNumber} is still open.`);
                break;
              }
            }

            if (allClosed) {
              console.log(`ğŸ”’ Closing parent issue #${parentIssueNumber} as all child issues are closed.`);
              await octokit.issues.update({
                ...repo,
                issue_number: parseInt(parentIssueNumber, 10),
                state: "closed"
              });
            } else {
              console.log(`â„¹ï¸ Parent issue #${parentIssueNumber} remains open as some child issues are still open.`);
            }
