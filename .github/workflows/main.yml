name: Close Parent Issue When All Tasks Done

on:
  issues:
    types: [closed]  # 子Issueが Closed になったときに実行

jobs:
  close-parent:
    runs-on: ubuntu-latest
    steps:
      - name: Check if parent issue should be closed
        uses: actions/github-script@v6
        with:
          script: |
            const issue_number = context.payload.issue.number;
            const repo = context.repo;
            const octokit = github.rest;
            
            // Get parent issue
            const parentIssue = await octokit.issues.get({
              ...repo,
              issue_number: issue_number
            });

            const body = parentIssue.data.body || "";  // 🛠 修正：null の場合は空文字にする
            const matches = body.match(/- \[ \] #(\d+)/g) || [];

            console.log(`ℹ️ Parent Issue #${issue_number} found with ${matches.length} tasks.`);

            // Check if all tasks are closed
            let allClosed = true;
            for (const match of matches) {
              const childNumber = parseInt(match.match(/#(\d+)/)[1], 10);
              const childIssue = await octokit.issues.get({ ...repo, issue_number: childNumber });
              if (childIssue.data.state !== "closed") {
                allClosed = false;
                console.log(`⚠️ Child Issue #${childNumber} is still open.`);
                break;
              }
            }

            // Close parent issue if all child issues are closed
            if (allClosed) {
              await octokit.issues.update({
                ...repo,
                issue_number: parentIssue.data.number,
                state: "closed"
              });
              console.log(`✅ Closed parent issue #${parentIssue.data.number}`);
            } else {
              console.log(`ℹ️ Parent issue #${parentIssue.data.number} remains open.`);
            }
