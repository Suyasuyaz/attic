name: Close Parent Issue When All Tasks Done

on:
  issues:
    types: [closed]  # å­IssueãŒ Closed ã«ãªã£ãŸã¨ãã«å®Ÿè¡Œ

jobs:
  close-parent:
    runs-on: ubuntu-latest
    steps:
      - name: Check if parent issue should be closed
        uses: actions/github-script@v6
        with:
          script: |
            const issue_number = context.payload.issue.number;
            const repo = context.repo;
            const octokit = github.rest;
            
            console.log(`ğŸ” Checking for parent issue related to child issue #${issue_number}`);

            // å­Issueã®æƒ…å ±ã‚’å–å¾—
            const childIssue = await octokit.issues.get({
              ...repo,
              issue_number: issue_number
            });

            if (!childIssue.data.body) {
              console.log(`âš ï¸ Child issue #${issue_number} has no body. Exiting.`);
              return;
            }

            // Parent Issue ã®ç•ªå·ã‚’å–å¾—
            let parentIssueNumber = null;
            const parentMatch = childIssue.data.body.match(/Parent Issue: #(\d+)/);
            if (parentMatch && parentMatch.length > 1) {
              parentIssueNumber = parseInt(parentMatch[1], 10);
            }

            if (!parentIssueNumber) {
              console.log(`âš ï¸ No parent issue reference found in child issue #${issue_number}. Exiting.`);
              return;
            }

            console.log(`ğŸ”— Found parent issue: #${parentIssueNumber}`);

            // è¦ªIssueã®æƒ…å ±ã‚’å–å¾—
            const parentIssue = await octokit.issues.get({
              ...repo,
              issue_number: parentIssueNumber
            });

            if (!parentIssue.data.body) {
              console.log(`âš ï¸ Parent issue #${parentIssueNumber} has no body. Exiting.`);
              return;
            }

            console.log("âœ… Parent issue body found, checking child tasks...");

            // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆï¼ˆå­Issueã®ãƒªã‚¹ãƒˆï¼‰ã‚’å–å¾—
            let matches = [];
            if (parentIssue.data.body) {
              matches = parentIssue.data.body.match(/- \[ \] #(\d+)/g) || [];
            }

            if (matches.length === 0) {
              console.log("âš ï¸ No child tasks found in parent issue. Exiting.");
              return;
            }

            console.log(`ğŸ“ Found ${matches.length} child tasks in parent issue.`);

            // ã™ã¹ã¦ã®å­IssueãŒClosedã‹ãƒã‚§ãƒƒã‚¯
            let allClosed = true;
            for (const match of matches) {
              const childNumberMatch = match.match(/#(\d+)/);
              if (!childNumberMatch) continue;

              const childNumber = parseInt(childNumberMatch[1], 10);
              const child = await octokit.issues.get({ ...repo, issue_number: childNumber });

              if (child.data.state !== "closed") {
                allClosed = false;
                console.log(`ğŸš¨ Child Issue #${childNumber} is still open.`);
                break;
              }
            }

            if (allClosed) {
              console.log(`ğŸ”’ Closing parent issue #${parentIssueNumber} as all child issues are closed.`);
              await octokit.issues.update({
                ...repo,
                issue_number: parentIssueNumber,
                state: "closed"
              });
            } else {
              console.log(`â„¹ï¸ Parent issue #${parentIssueNumber} remains open as some child issues are still open.`);
            }
